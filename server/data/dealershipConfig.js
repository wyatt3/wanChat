// Dealership configuration - AI-generated cars
const fs = require('fs');
const path = require('path');
const ollamaService = require('../services/ollamaService');

const DATA_DIR = path.join(__dirname, '../../data');
const DEALERSHIP_FILE = path.join(DATA_DIR, 'dealershipCars.json');

// Ensure data directory exists
if (!fs.existsSync(DATA_DIR)) {
  fs.mkdirSync(DATA_DIR, { recursive: true });
}

// Current dealership cars (generated by AI)
let currentCars = {};
let lastRefreshTime = 0;
let isGenerating = false;
let initialLoadComplete = false;

// Generate random hidden specs for a car (these are the "true" performance numbers)
function generateRandomSpecs(car) {
  // Base specs from AI with random variance (+/- 15%)
  const variance = () => 0.85 + Math.random() * 0.3;

  // Category-based multipliers for realistic scaling
  const categoryMultipliers = {
    beater: { speed: 0.6, accel: 0.5, handling: 0.6, reliability: 0.4 },
    sedan: { speed: 0.7, accel: 0.6, handling: 0.7, reliability: 0.8 },
    suv: { speed: 0.65, accel: 0.55, handling: 0.6, reliability: 0.75 },
    truck: { speed: 0.6, accel: 0.5, handling: 0.5, reliability: 0.8 },
    sports: { speed: 0.85, accel: 0.8, handling: 0.85, reliability: 0.7 },
    muscle: { speed: 0.8, accel: 0.85, handling: 0.6, reliability: 0.65 },
    luxury: { speed: 0.75, accel: 0.7, handling: 0.75, reliability: 0.9 },
    supercar: { speed: 0.95, accel: 0.9, handling: 0.9, reliability: 0.6 },
    hypercar: { speed: 1.0, accel: 0.95, handling: 0.95, reliability: 0.5 },
    vintage: { speed: 0.7, accel: 0.6, handling: 0.65, reliability: 0.3 }
  };

  const mult = categoryMultipliers[car.category] || categoryMultipliers.sedan;

  return {
    // True top speed (affects race progress rate)
    trueTopSpeed: Math.floor(car.topSpeed * variance()),
    // True acceleration (affects how fast you reach top speed)
    trueAcceleration: Math.floor(Math.min(100, car.acceleration * mult.accel * variance())),
    // True handling (affects pothole dodge success)
    trueHandling: Math.floor(Math.min(100, car.handling * mult.handling * variance())),
    // Reliability (chance of random breakdown/slowdown)
    reliability: Math.floor(Math.min(100, 50 + (car.price / 100000) * mult.reliability * variance())),
    // Nitro boost capacity (1-3 uses per race)
    nitroCharges: Math.floor(1 + Math.random() * 3),
    // Weight affects acceleration penalty
    trueWeight: Math.floor(car.weight * variance()),
    // Hidden quirks
    quirk: generateQuirk()
  };
}

// Generate a random quirk for the car
function generateQuirk() {
  const quirks = [
    { name: 'Turbo Lag', effect: 'slow_start', description: 'Takes a moment to get going' },
    { name: 'Nitro Expert', effect: 'better_nitro', description: 'Nitro boosts are more effective' },
    { name: 'Pothole Magnet', effect: 'bad_luck', description: 'Seems to find every pothole' },
    { name: 'Lucky', effect: 'good_luck', description: 'Lady luck rides along' },
    { name: 'Smooth Ride', effect: 'pothole_resist', description: 'Potholes barely slow it down' },
    { name: 'Glass Cannon', effect: 'fast_fragile', description: 'Fast but fragile' },
    { name: 'Reliable', effect: 'no_breakdown', description: 'Never breaks down' },
    { name: 'Sleeper', effect: 'hidden_power', description: 'More power than it looks' },
    { name: 'Show Car', effect: 'style_bonus', description: 'Looks fast, drives... okay' },
    { name: 'None', effect: 'none', description: 'Nothing special' }
  ];
  return quirks[Math.floor(Math.random() * quirks.length)];
}

// Load saved dealership cars
function loadDealershipCars() {
  try {
    if (fs.existsSync(DEALERSHIP_FILE)) {
      const data = JSON.parse(fs.readFileSync(DEALERSHIP_FILE, 'utf8'));
      if (data.cars && data.refreshTime) {
        currentCars = data.cars;
        lastRefreshTime = data.refreshTime;
        console.log(`Loaded ${Object.keys(currentCars).length} dealership cars from disk`);
        return true;
      }
    }
  } catch (error) {
    console.error('Failed to load dealership cars:', error.message);
  }
  return false;
}

// Save dealership cars to disk
function saveDealershipCars() {
  try {
    fs.writeFileSync(DEALERSHIP_FILE, JSON.stringify({
      cars: currentCars,
      refreshTime: lastRefreshTime
    }, null, 2));
  } catch (error) {
    console.error('Failed to save dealership cars:', error.message);
  }
}

// Calculate current 30-minute window (cars refresh less often than store items)
function getCurrentWindow() {
  const now = new Date();
  const minutes = now.getMinutes();
  const windowMinutes = Math.floor(minutes / 30) * 30;
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), windowMinutes, 0, 0).getTime();
}

// Check if dealership needs refresh
function needsRefresh() {
  const currentWindow = getCurrentWindow();
  return currentWindow > lastRefreshTime;
}

// Generate new cars via AI
async function generateCars(count = 8) {
  const prompt = `Generate ${count} unique cars for a virtual dealership. Include a mix of:
- Beaters/junkers (cheap, funny descriptions)
- Regular sedans and SUVs
- Sports cars
- Muscle cars
- Luxury vehicles
- Supercars
- Rare vintage/collector cars

For each car output EXACTLY this JSON format, one car per line:
{"id":"unique_id","name":"Year Make Model","description":"Funny description","price":NUMBER,"category":"beater/sedan/suv/truck/sports/muscle/luxury/supercar/hypercar/vintage","rarity":"common/uncommon/rare/legendary/mythic/ultra","emoji":"car emoji","topSpeed":NUMBER,"horsepower":NUMBER,"acceleration":NUMBER,"handling":NUMBER,"weight":NUMBER}

Stats explained (1-100 scale except topSpeed which is mph and weight which is lbs):
- topSpeed: max speed in mph (60-280 depending on car)
- horsepower: engine power (50-1500)
- acceleration: 0-60 time inverted to 1-100 (higher = faster acceleration)
- handling: cornering ability 1-100 (higher = better control)
- weight: car weight in lbs (2000-6000)

Price guidelines:
- beater/common: $500-5,000
- sedan/suv/truck uncommon: $10,000-60,000
- sports/muscle rare: $30,000-150,000
- luxury/supercar legendary: $100,000-500,000
- hypercar mythic: $1,000,000-5,000,000
- vintage ultra: $5,000,000-50,000,000

Be creative and funny! Output ONLY the JSON lines, nothing else.`;

  try {
    const response = await ollamaService.ollamaRequest(prompt, { temperature: 0.9, maxTokens: 2500 });
    const cars = [];
    const lines = response.split('\n').filter(line => line.trim().startsWith('{'));

    for (const line of lines) {
      try {
        const car = JSON.parse(line.trim());
        // Validate required fields
        if (car.id && car.name && car.price && car.category) {
          car.price = parseInt(car.price) || 10000;
          car.horsepower = parseInt(car.horsepower) || 150;
          car.topSpeed = parseInt(car.topSpeed) || 100;
          car.acceleration = parseInt(car.acceleration) || 50;
          car.handling = parseInt(car.handling) || 50;
          car.weight = parseInt(car.weight) || 3000;

          // Generate hidden random specs (vary by +/- 10-20% from base)
          car.specs = generateRandomSpecs(car);

          cars.push(car);
        }
      } catch (e) {
        // Skip malformed JSON lines
      }
    }

    return cars;
  } catch (error) {
    console.error('Failed to generate cars:', error.message);
    return null;
  }
}

// Refresh dealership inventory (with retry on failure)
async function refreshDealershipCars(broadcast = null, retryCount = 0) {
  if (isGenerating) {
    console.log('Dealership refresh already in progress...');
    return;
  }

  const maxRetries = 3;
  isGenerating = true;
  console.log('Generating new dealership inventory via AI...');

  if (broadcast) {
    broadcast('ðŸš— New shipment arriving at the dealership...');
  }

  try {
    const aiCars = await generateCars(8);

    if (aiCars && aiCars.length > 0) {
      currentCars = {};
      aiCars.forEach(car => {
        const baseId = car.id || car.name.toLowerCase().replace(/[^a-z0-9]/g, '_');
        let id = baseId;
        let counter = 1;
        while (currentCars[id]) {
          id = `${baseId}_${counter++}`;
        }
        car.id = id;
        currentCars[id] = car;
      });

      lastRefreshTime = getCurrentWindow();
      saveDealershipCars();
      initialLoadComplete = true;
      console.log(`Generated ${Object.keys(currentCars).length} new cars`);

      if (broadcast) {
        broadcast(`ðŸš— New cars on the lot! Check /dealership for ${Object.keys(currentCars).length} fresh rides!`);
      }
    } else {
      throw new Error('AI returned no valid cars');
    }
  } catch (error) {
    console.error(`AI car generation failed (attempt ${retryCount + 1}/${maxRetries}):`, error.message);

    isGenerating = false;

    // Retry if we haven't exceeded max retries
    if (retryCount < maxRetries - 1) {
      console.log(`Retrying dealership generation in 5 seconds...`);
      if (broadcast) {
        broadcast(`ðŸš— Dealership generation failed, retrying... (${retryCount + 2}/${maxRetries})`);
      }
      await new Promise(resolve => setTimeout(resolve, 5000));
      return refreshDealershipCars(broadcast, retryCount + 1);
    } else {
      console.error('All dealership generation attempts failed. Dealership will be empty until next refresh.');
      if (broadcast) {
        broadcast('ðŸš— Dealership generation failed. Try /refreshdealership to retry.');
      }
    }
  }

  isGenerating = false;
}

// Initialize dealership on load - always generate fresh AI cars on startup
async function initializeDealership() {
  const loaded = loadDealershipCars();

  // If we have saved cars and they're not expired, use them
  if (loaded && !needsRefresh() && Object.keys(currentCars).length > 0) {
    console.log('Using cached dealership cars');
    initialLoadComplete = true;
    return;
  }

  // Otherwise, generate new cars from AI
  console.log('Generating fresh dealership cars from AI on startup...');
  await refreshDealershipCars();
}

// Get available cars
function getAvailableCars() {
  if (needsRefresh() && !isGenerating) {
    refreshDealershipCars().catch(console.error);
  }
  return Object.values(currentCars);
}

// Get a specific car by ID
function getCar(carId) {
  return currentCars[carId] || null;
}

// Get all cars
function getAllCars() {
  return currentCars;
}

// Calculate time until next refresh
function getTimeUntilRefresh() {
  const now = new Date();
  const minutes = now.getMinutes();
  const seconds = now.getSeconds();
  const minutesUntilRefresh = 30 - (minutes % 30) - (seconds > 0 ? 1 : 0);
  const secondsUntilRefresh = seconds > 0 ? 60 - seconds : 0;
  return { minutes: minutesUntilRefresh, seconds: secondsUntilRefresh };
}

// Manual refresh trigger
async function forceRefresh(broadcast = null) {
  await refreshDealershipCars(broadcast);
}

// Initialize on module load (async)
initializeDealership().catch(console.error);

module.exports = {
  getAvailableCars,
  getCar,
  getAllCars,
  getTimeUntilRefresh,
  forceRefresh,
  needsRefresh,
  isGenerating: () => isGenerating,
  isReady: () => initialLoadComplete
};
